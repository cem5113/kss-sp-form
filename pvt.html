<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>PVT Reaction Time Test</title>
  <style>
    body {
      font-family: sans-serif;
      text-align: center;
      background-color: #f4f4f4;
      padding: 20px;
      caret-color: transparent;
    }
    #stimulus {
      width: 200px;
      height: 200px;
      background-color: red;
      border-radius: 50%;
      margin: 100px auto;
      display: none;
      cursor: pointer;
    }
    #results, #message {
      margin-top: 20px;
    }
    #countdown {
      font-size: 2em;
      margin-top: 20px;
    }
    #rules {
      background-color: #fff;
      padding: 15px;
      border-radius: 10px;
      margin: 20px auto;
      max-width: 600px;
      text-align: left;
      box-shadow: 0 0 5px rgba(0,0,0,0.1);
    }
    #message {
      color: white;
      background-color: #e74c3c;
      padding: 10px;
      border-radius: 8px;
      display: none;
      max-width: 500px;
      margin: 10px auto;
    }
  </style>
</head>
<body>
  <h1>üß† Pilot PVT Reaction Test</h1>

  <div id="rules">
    <h3>Test Rules:</h3>
    <ul>
      <li>You will see a <strong>red circle</strong>.</li>
      <li>Click the red circle <strong>once</strong> as fast as possible after it appears.</li>
      <li><strong>Any click outside the red circle</strong> is considered a false click.</li>
      <li><u>Please click only once. Double-clicking will be counted as a mistake.</u></li>
      <li>After <strong>3 false clicks</strong>, the current attempt will be terminated.</li>
      <li>You have <strong>2 total attempts</strong>.</li>
      <li>If the test is not completed within <strong>1 minute</strong>, it will automatically fail.</li>
    </ul>
  </div>

  <button id="startBtn">Start Test</button>
  <div id="countdown"></div>
  <div id="stimulus" onclick="recordReaction(event)"></div>
  <div id="message"></div>
  <div id="results"></div>

  <script>
    const TOTAL_TRIALS = 10;
    const MAX_FALSE_CLICKS = 3;
    const MAX_ATTEMPTS = 2;
    const MAX_DURATION_MS = 60 * 1000;

    let trial = 0;
    let startTime = 0;
    let results = [];
    let falseClickCount = 0;
    let attemptCount = 0;
    let stimulusVisible = false;
    let testLocked = false;
    let testActive = false;
    let testTimer = null;
    let stimulusTimeout = null;

    function showMessage(text) {
      const messageDiv = document.getElementById("message");
      messageDiv.innerText = text;
      messageDiv.style.display = "block";
      setTimeout(() => {
        messageDiv.style.display = "none";
      }, 2500);
    }

    document.addEventListener("click", function(event) {
      if (!testActive || testLocked) return;

      const stimulus = document.getElementById("stimulus");
      const clickedStimulus = stimulus.contains(event.target);

      if (!clickedStimulus && event.target.id !== "startBtn") {
        falseClickCount++;
        if (falseClickCount > MAX_FALSE_CLICKS) {
          handleAttemptFail("Too many false clicks.");
        } else {
          showMessage(`‚ùó Invalid click! (${falseClickCount}/${MAX_FALSE_CLICKS}) Click ONLY inside the red circle.`);
        }
      }
    });

    function waitAndShowStimulus() {
      const delay = 2000 + Math.random() * 3000;
      stimulusTimeout = setTimeout(() => {
        if (!testActive) return;
        startTime = performance.now();
        stimulusVisible = true;
        document.getElementById("stimulus").style.display = "block";
      }, delay);
    }

    function recordReaction(event) {
      event.stopPropagation();
      if (!stimulusVisible) return;

      const endTime = performance.now();
      const rt = Math.round(endTime - startTime);
      results.push(rt);
      document.getElementById("stimulus").style.display = "none";
      stimulusVisible = false;

      trial++;
      if (trial < TOTAL_TRIALS) {
        waitAndShowStimulus();
      } else {
        clearTimeout(testTimer);
        showResults();
        testActive = false;
        document.getElementById("startBtn").style.display = "inline-block";
      }
    }

    function handleAttemptFail(reason = "") {
      clearTimeout(stimulusTimeout);
      clearTimeout(testTimer);
      document.getElementById("stimulus").style.display = "none";
      stimulusVisible = false;
      testActive = false;

      attemptCount++;
      if (attemptCount >= MAX_ATTEMPTS) {
        document.getElementById("results").innerHTML = `
          <h3>‚ùå Test Failed</h3>
          <p>${reason || "You failed both attempts."}</p>
          <p>Please contact your supervisor.</p>`;
        testLocked = true;
        document.getElementById("startBtn").style.display = "none";
      } else {
        document.getElementById("results").innerHTML = `
          <h3>‚ö†Ô∏è Attempt Failed</h3>
          <p>${reason || "Please try again."}</p>`;
        document.getElementById("startBtn").style.display = "inline-block";
      }
    }

    function showResults() {
      const avg = Math.round(results.reduce((a, b) => a + b, 0) / results.length);
      const max = Math.max(...results);
      const min = Math.min(...results);
      const lapses = results.filter(rt => rt > 500).length;

      document.getElementById("results").innerHTML = `
        <h3>‚úÖ Test Completed</h3>
        <p><strong>Total Trials:</strong> ${results.length}</p>
        <p><strong>Average Reaction Time:</strong> ${avg} ms</p>
        <p><strong>Fastest:</strong> ${min} ms</p>
        <p><strong>Slowest:</strong> ${max} ms</p>
        <p><strong>Lapses (RT > 500 ms):</strong> ${lapses}</p>
        <p><strong>All Reaction Times:</strong> ${results.join(', ')}</p>`;
    }

    function startTest() {
      if (testLocked) return;

      clearTimeout(stimulusTimeout);
      document.getElementById("rules").style.display = "none";
      document.getElementById("startBtn").style.display = "none";
      document.getElementById("results").innerHTML = "";
      document.getElementById("countdown").innerText = "";
      document.getElementById("stimulus").style.display = "none";

      trial = 0;
      results = [];
      falseClickCount = 0;
      stimulusVisible = false;
      testActive = true;

      testTimer = setTimeout(() => {
        if (testActive) {
          handleAttemptFail("‚è∞ Time limit exceeded. Test took longer than 1 minute.");
        }
      }, MAX_DURATION_MS);

      let count = 5;
      const countdownDiv = document.getElementById("countdown");
      const countdownInterval = setInterval(() => {
        countdownDiv.innerText = count;
        count--;
        if (count < 0) {
          clearInterval(countdownInterval);
          countdownDiv.innerText = "";
          waitAndShowStimulus();
        }
      }, 1000);
    }

    const startBtn = document.getElementById("startBtn");
    startBtn.addEventListener("click", startTest);
    startBtn.addEventListener("dblclick", startTest);
  </script>
</body>
</html>
